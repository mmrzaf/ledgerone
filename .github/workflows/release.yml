name: Release – LedgerOne (all platforms)

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

env:
  FLUTTER_CHANNEL: stable
  ARTIFACT_RETENTION_DAYS: 30
  APP_NAME: LedgerOne

jobs:
  prepare:
    name: Prepare release metadata
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.tag.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: tag
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "version=${TAG}" >> "$GITHUB_OUTPUT"

      - name: Print release info
        run: echo "Releasing $APP_NAME version ${{ steps.tag.outputs.version }}"

  build-android:
    name: Android – APK & AAB
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Android APK (release)
        run: flutter build apk --release

      - name: Build Android App Bundle (AAB, release)
        run: flutter build appbundle --release

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-web:
    name: Web – static bundle
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build web (release)
        run: flutter build web --release

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web
          path: build/web
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-linux:
    name: Linux – x64 bundle
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux / sqflite dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang cmake ninja-build pkg-config \
            libgtk-3-dev libglib2.0-dev libpulse-dev libasound2-dev \
            libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
            sqlite3 libsqlite3-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Linux (release)
        run: flutter build linux --release

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: build/linux/x64/release/bundle
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-windows:
    name: Windows – x64 bundle
    runs-on: windows-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter on Windows
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Windows (release)
        run: flutter build windows --release

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: build\windows\x64\runner\Release
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-macos:
    name: macOS – x64 app
    runs-on: macos-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter on macOS
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build macOS (release)
        run: flutter build macos --release

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: build/macos/Build/Products/Release
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  build-ios:
    name: iOS – app / IPA
    runs-on: macos-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter on macOS
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build iOS
        shell: bash
        run: |
          set -euo pipefail

          if [ -n "${{ secrets.APPLE_CERT }}" ] && [ -n "${{ secrets.APPLE_PROVISION }}" ]; then
            echo "Apple signing secrets found – building signed IPA."
            flutter build ipa \
              --export-method ad-hoc \
              --no-tree-shake-icons
          else
            echo "No Apple signing secrets – building unsigned iOS app (no codesign)."
            flutter build ios --no-codesign --release
          fi

      - name: Upload iOS Runner.app (unsigned build)
        uses: actions/upload-artifact@v4
        if: ${{ hashFiles('build/ios/iphoneos/Runner.app/**') != '' }}
        with:
          name: ios
          path: build/ios/iphoneos/Runner.app
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Upload iOS IPA (if produced)
        uses: actions/upload-artifact@v4
        if: ${{ hashFiles('build/ios/ipa/*.ipa') != '' }}
        with:
          name: ios
          path: build/ios/ipa/*.ipa
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

  create-github-release:
    name: GitHub Release – attach artifacts
    needs:
      - prepare
      - build-android
      - build-web
      - build-linux
      - build-windows
      - build-macos
      - build-ios
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Package release files (zip only what makes sense)
        shell: bash
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          set -euo pipefail

          cd release-artifacts
          mkdir -p dist

          APP="${APP_NAME:-LedgerOne}"
          RAW_VERSION="${VERSION:-dev}"
          V="${RAW_VERSION//\//-}"

          echo "Packaging ${APP} ${V}"

          # ----- ZIPS multi-file bundles -----
          if [ -d web ]; then
            zip -r "dist/${APP}-${V}-web.zip" web
          fi

          if [ -d linux ]; then
            zip -r "dist/${APP}-${V}-linux-x64.zip" linux
          fi

          if [ -d windows ]; then
            zip -r "dist/${APP}-${V}-windows-x64.zip" windows
          fi

          if [ -d macos ]; then
            zip -r "dist/${APP}-${V}-macos-x64.zip" macos
          fi

          # ----- RAW FILES -----
          # Android APK / AAB
          if [ -d android ]; then
            APK="$(find android -maxdepth 5 -type f -name 'app-release.apk' | head -n 1 || true)"
            if [ -n "$APK" ]; then
              cp "$APK" "dist/${APP}-${V}-android.apk"
            fi

            AAB="$(find android -maxdepth 5 -type f -name 'app-release.aab' | head -n 1 || true)"
            if [ -n "$AAB" ]; then
              cp "$AAB" "dist/${APP}-${V}-android.aab"
            fi
          fi

          # iOS IPA (if it exists)
          if [ -d ios ]; then
            IPA="$(find ios -maxdepth 5 -type f -name '*.ipa' | head -n 1 || true)"
            if [ -n "$IPA" ]; then
              cp "$IPA" "dist/${APP}-${V}-ios.ipa"
            fi
          fi

          echo "Final release files:"
          ls -lh dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "${{ env.APP_NAME }} ${{ github.ref_name }}"
          body: |
            LedgerOne – offline-first personal finance & crypto tracking.

            Built from tag `${{ github.ref_name }}`.

            Included artifacts:
            - Android: APK + AAB
            - Web build (static bundle)
            - Linux x64 bundle
            - Windows x64 bundle
            - macOS x64 app bundle
            - iOS IPA

          files: release-artifacts/dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

