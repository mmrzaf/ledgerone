name: Release (build all platforms)

on:
  push:
    tags:
      - '*'

env:
  FLUTTER_CHANNEL: stable

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get tag version
        id: get_version
        run: |
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "Releasing version: ${{ steps.get_version.outputs.version }}"

  build-android:
    name: Build Android (apk + aab)
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Pub get
        run: flutter pub get

      - name: Build release APK
        run: flutter build apk --release

      - name: Build app bundle (AAB)
        run: flutter build appbundle --release

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Pub get
        run: flutter pub get

      - name: Build web (release)
        run: flutter build web --release

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-artifact
          path: build/web
          retention-days: 30

  build-linux:
    name: Build Linux (release)
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Install native build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang cmake pkg-config \
            libgtk-3-dev libglib2.0-dev libpulse-dev libasound2-dev \
            libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Pub get
        run: flutter pub get

      - name: Build linux (release)
        run: flutter build linux --release

      - name: Upload linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifact
          path: build/linux/x64/release/bundle
          retention-days: 30

  build-windows:
    name: Build Windows (release)
    runs-on: windows-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter on Windows
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Pub get
        run: flutter pub get

      - name: Build windows (release)
        run: flutter build windows --release

      - name: Upload windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifact
          path: build\windows\x64\runner\Release
          retention-days: 30

  build-macos:
    name: Build macOS (release)
    runs-on: macos-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter on macOS
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Pub get
        run: flutter pub get

      - name: Build macOS (release)
        run: flutter build macos --release

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifact
          path: build/macos/Build/Products/Release
          retention-days: 30

  build-ios:
    name: Build iOS (xcarchive / ipa)
    runs-on: macos-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter on macOS
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}

      - name: Pub get
        run: flutter pub get

      - name: Build iOS archive (xcarchive) without codesign if no secrets
        run: |
          set -euo pipefail
          if [ -n "${{ secrets.APPLE_CERT }}" ] && [ -n "${{ secrets.APPLE_PROVISION }}" ]; then
            echo "Signing assets provided. Proceeding with signed build (you must configure codesign steps)."
            flutter build ipa --export-method ad-hoc --no-tree-shake-icons --build-number="${{ needs.prepare.outputs.version }}" || flutter build ipa
          else
            echo "No Apple signing secrets provided. Building without codesign (xcarchive)."
            # build without codesign; don't fail workflow if this step can't produce a signed ipa
            flutter build ios --no-codesign --release || true
          fi
        shell: bash

      - name: Upload ios artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifact
          path: |
            build/ios/iphoneos/Runner.app
            build/ios/iphoneos/*.xcarchive
          retention-days: 30

  create-github-release:
    name: Create GitHub Release and attach artifacts
    needs:
      - build-android
      - build-web
      - build-linux
      - build-windows
      - build-macos
      - build-ios
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      
      - name: Create ZIP Archives for Release
        run: |
          cd release-artifacts
          zip -r android.zip android-artifacts
          zip -r web.zip web-artifact
          zip -r linux.zip linux-artifact
          zip -r windows.zip windows-artifact
          zip -r macos.zip macos-artifact
          zip -r ios.zip ios-artifact
          ls -l *.zip
        shell: bash

      - name: Create GitHub Release
        id: gh_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: "Automated build artifacts for tag ${{ github.ref_name }}."
          files: release-artifacts/*.zip 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
