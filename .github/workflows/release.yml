name: Release â€“ LedgerOne (all platforms)

on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0 or dev-test)'
        required: false
        default: 'dev-manual'

env:
  FLUTTER_CHANNEL: stable
  ARTIFACT_RETENTION_DAYS: 30
  APP_NAME: LedgerOne

permissions:
  contents: read

jobs:
  prepare:
    name: Prepare release metadata
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      version: ${{ steps.tag.outputs.version }}
      is_release: ${{ steps.tag.outputs.is_release }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract and validate version
        id: tag
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_RELEASE="false"
          elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            IS_RELEASE="true"
            # Validate semver format
            if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
              echo "::error::Invalid version format: $VERSION. Expected: 1.0.0 or 1.0.0-beta.1"
              exit 1
            fi
          else
            VERSION="dev-${GITHUB_REF_NAME//\//-}"
            IS_RELEASE="false"
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "is_release=${IS_RELEASE}" >> "$GITHUB_OUTPUT"
          echo "::notice::Version: ${VERSION}, Release: ${IS_RELEASE}"

      - name: Print release info
        run: |
          echo "ðŸš€ Releasing $APP_NAME"
          echo "Version: ${{ steps.tag.outputs.version }}"
          echo "Is Release: ${{ steps.tag.outputs.is_release }}"
          echo "Ref: $GITHUB_REF"

  build-android:
    name: Android â€“ APK & AAB
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 30
    environment: release
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          set -euo pipefail

          if [[ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]]; then
            echo "::error::ANDROID_KEYSTORE_BASE64 secret is not set"
            exit 1
          fi

          if [[ -z "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" ]]; then
            echo "::error::ANDROID_KEYSTORE_PASSWORD secret is not set"
            exit 1
          fi

          echo "All required secrets are present"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Verify Flutter installation
        run: |
          flutter --version
          flutter doctor -v

      - name: Restore Android keystore
        run: |
          set -euo pipefail
          mkdir -p android
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/ledgerone-release.keystore

          # Verify keystore file was created and has content
          if [[ ! -s android/ledgerone-release.keystore ]]; then
            echo "::error::Keystore file is empty or not created"
            exit 1
          fi

          echo "Keystore restored successfully"
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Create key.properties
        run: |
          set -euo pipefail

          cat > android/key.properties << EOF
          storeFile=../ledgerone-release.keystore
          storePassword=${ANDROID_KEYSTORE_PASSWORD}
          keyAlias=${ANDROID_KEY_ALIAS}
          keyPassword=${ANDROID_KEY_PASSWORD}
          EOF

          # Verify file was created
          if [[ ! -f android/key.properties ]]; then
            echo "::error::Failed to create key.properties"
            exit 1
          fi

          echo "key.properties created (content hidden for security)"
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Flutter pub get
        run: flutter pub get

      - name: Run Flutter analyze
        run: flutter analyze --no-fatal-infos
        continue-on-error: true

      - name: Build Android APK (release)
        run: |
          set -euo pipefail
          flutter build apk --release

          # Verify APK was created
          if [[ ! -f build/app/outputs/flutter-apk/app-release.apk ]]; then
            echo "::error::APK build failed - file not found"
            exit 1
          fi

          # Check APK size is reasonable (> 5MB)
          APK_SIZE=$(stat -c%s build/app/outputs/flutter-apk/app-release.apk)
          if [[ $APK_SIZE -lt 5000000 ]]; then
            echo "::warning::APK size is suspiciously small: $APK_SIZE bytes"
          fi

          echo "APK built successfully ($(numfmt --to=iec-i --suffix=B $APK_SIZE))"

      - name: Build Android App Bundle (AAB, release)
        run: |
          set -euo pipefail
          flutter build appbundle --release

          # Verify AAB was created
          if [[ ! -f build/app/outputs/bundle/release/app-release.aab ]]; then
            echo "::error::AAB build failed - file not found"
            exit 1
          fi

          AAB_SIZE=$(stat -c%s build/app/outputs/bundle/release/app-release.aab)
          echo "AAB built successfully ($(numfmt --to=iec-i --suffix=B $AAB_SIZE))"

      - name: Generate checksums
        run: |
          cd build/app/outputs/flutter-apk
          sha256sum app-release.apk > app-release.apk.sha256
          cd -
          cd build/app/outputs/bundle/release
          sha256sum app-release.aab > app-release.aab.sha256

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/flutter-apk/app-release.apk.sha256
            build/app/outputs/bundle/release/app-release.aab
            build/app/outputs/bundle/release/app-release.aab.sha256
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: error

      - name: Cleanup sensitive files
        if: always()
        run: |
          rm -f android/key.properties
          rm -f android/ledgerone-release.keystore
          echo "Cleaned up sensitive files"

  build-web:
    name: Web â€“ static bundle
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build web (release)
        run: |
          set -euo pipefail
          flutter build web --release

          # Verify build output
          if [[ ! -f build/web/index.html ]]; then
            echo "::error::Web build failed - index.html not found"
            exit 1
          fi

          echo "Web build completed successfully"

      - name: Generate build manifest
        run: |
          cd build/web
          find . -type f -exec sha256sum {} \; > checksums.txt
          echo "Generated checksums for $(wc -l < checksums.txt) files"

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web
          path: build/web
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: error

  build-linux:
    name: Linux â€“ x64 bundle
    runs-on: ubuntu-latest
    needs: prepare
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang cmake ninja-build pkg-config \
            libgtk-3-dev libglib2.0-dev libpulse-dev libasound2-dev \
            libx11-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev \
            sqlite3 libsqlite3-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Linux (release)
        run: |
          set -euo pipefail
          flutter build linux --release

          # Verify executable
          BINARY="build/linux/x64/release/bundle/${{ env.APP_NAME }}"
          if [[ ! -f "$BINARY" ]] && [[ ! -f "build/linux/x64/release/bundle/ledgerone" ]]; then
            echo "::error::Linux binary not found"
            exit 1
          fi

          echo "Linux build completed successfully"

      - name: Generate checksums
        run: |
          cd build/linux/x64/release/bundle
          find . -type f -exec sha256sum {} \; > checksums.txt

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux
          path: build/linux/x64/release/bundle
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: error

  build-windows:
    name: Windows â€“ x64 bundle
    runs-on: windows-latest
    needs: prepare
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter on Windows
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build Windows (release)
        shell: pwsh
        run: |
          flutter build windows --release

          # Verify executable
          $exe = "build\windows\x64\runner\Release\$env:APP_NAME.exe"
          if (-not (Test-Path $exe)) {
            $exe = "build\windows\x64\runner\Release\ledgerone.exe"
            if (-not (Test-Path $exe)) {
              Write-Error "Windows executable not found"
              exit 1
            }
          }

          Write-Host "Windows build completed successfully"

      - name: Generate checksums
        shell: pwsh
        run: |
          cd build\windows\x64\runner\Release
          Get-ChildItem -File -Recurse | ForEach-Object {
            $hash = (Get-FileHash $_.FullName -Algorithm SHA256).Hash
            "$hash  $($_.FullName)" | Out-File -Append -Encoding utf8 checksums.txt
          }

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: build\windows\x64\runner\Release
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: error

  build-macos:
    name: macOS â€“ x64 app
    runs-on: macos-latest
    needs: prepare
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter on macOS
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build macOS (release)
        run: |
          set -euo pipefail
          flutter build macos --release

          # Verify app bundle
          if [[ ! -d "build/macos/Build/Products/Release/$APP_NAME.app" ]] && \
             [[ ! -d "build/macos/Build/Products/Release/LedgerOne.app" ]]; then
            echo "::error::macOS app bundle not found"
            exit 1
          fi

          echo "macOS build completed successfully"

      - name: Generate checksums
        run: |
          cd build/macos/Build/Products/Release
          find . -type f -exec shasum -a 256 {} \; > checksums.txt

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos
          path: build/macos/Build/Products/Release
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: error

  build-ios:
    name: iOS â€“ app / IPA
    runs-on: macos-latest
    needs: prepare
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter on macOS
        uses: subosito/flutter-action@v2
        with:
          channel: ${{ env.FLUTTER_CHANNEL }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build iOS
        shell: bash
        run: |
          set -euo pipefail

          if [[ -n "${{ secrets.APPLE_CERT }}" ]] && [[ -n "${{ secrets.APPLE_PROVISION }}" ]]; then
            echo "Apple signing secrets found â€“ building signed IPA"
            flutter build ipa \
              --export-method ad-hoc \
              --no-tree-shake-icons

            # Verify IPA
            IPA_COUNT=$(find build/ios/ipa -name "*.ipa" 2>/dev/null | wc -l)
            if [[ $IPA_COUNT -eq 0 ]]; then
              echo "::error::IPA build failed - no IPA file found"
              exit 1
            fi
            echo "Signed IPA built successfully"
          else
            echo "No Apple signing secrets â€“ building unsigned iOS app"
            flutter build ios --no-codesign --release

            # Verify app
            if [[ ! -d "build/ios/iphoneos/Runner.app" ]]; then
              echo "::error::iOS build failed - Runner.app not found"
              exit 1
            fi
            echo "Unsigned iOS app built successfully"
          fi

      - name: Generate checksums
        run: |
          if [[ -d build/ios/ipa ]]; then
            cd build/ios/ipa
            find . -name "*.ipa" -exec shasum -a 256 {} \; > checksums.txt
          elif [[ -d build/ios/iphoneos/Runner.app ]]; then
            cd build/ios/iphoneos
            find Runner.app -type f -exec shasum -a 256 {} \; > checksums.txt
          fi

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios
          path: |
            build/ios/ipa/*.ipa
            build/ios/ipa/checksums.txt
            build/ios/iphoneos/Runner.app
            build/ios/iphoneos/checksums.txt
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
          if-no-files-found: warn

  create-github-release:
    name: GitHub Release
    if: needs.prepare.outputs.is_release == 'true'
    needs:
      - prepare
      - build-android
      - build-web
      - build-linux
      - build-windows
      - build-macos
      - build-ios
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Verify downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          find release-artifacts -type f -ls

          # Verify checksums exist
          CHECKSUM_COUNT=$(find release-artifacts -name "*.sha256" -o -name "checksums.txt" | wc -l)
          echo "Found $CHECKSUM_COUNT checksum files"

      - name: Package release files
        shell: bash
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          set -euo pipefail

          cd release-artifacts
          mkdir -p dist

          APP="${APP_NAME}"
          V="${VERSION}"

          echo "Packaging ${APP} ${V}"

          # Function to create zip with verification
          create_zip() {
            local name=$1
            local source=$2
            if [[ -d "$source" ]]; then
              echo "Creating $name..."
              zip -r "dist/$name" "$source"
              if [[ ! -f "dist/$name" ]]; then
                echo "::error::Failed to create $name"
                return 1
              fi
              echo "Created $name ($(stat -c%s "dist/$name" | numfmt --to=iec-i --suffix=B))"
            else
              echo "Source directory not found: $source"
            fi
          }

          # Create platform-specific zips
          create_zip "${APP}-${V}-web.zip" "web"
          create_zip "${APP}-${V}-linux-x64.zip" "linux"
          create_zip "${APP}-${V}-windows-x64.zip" "windows"
          create_zip "${APP}-${V}-macos-x64.zip" "macos"

          # Copy Android artifacts
          if [[ -d android ]]; then
            APK=$(find android -name 'app-release.apk' -type f | head -n 1)
            AAB=$(find android -name 'app-release.aab' -type f | head -n 1)

            if [[ -n "$APK" ]]; then
              cp "$APK" "dist/${APP}-${V}-android.apk"
              if [[ -f "${APK}.sha256" ]]; then
                cp "${APK}.sha256" "dist/${APP}-${V}-android.apk.sha256"
              fi
              echo "Copied Android APK"
            fi

            if [[ -n "$AAB" ]]; then
              cp "$AAB" "dist/${APP}-${V}-android.aab"
              if [[ -f "${AAB}.sha256" ]]; then
                cp "${AAB}.sha256" "dist/${APP}-${V}-android.aab.sha256"
              fi
              echo "Copied Android AAB"
            fi
          fi

          # Handle iOS artifacts
          if [[ -d ios ]]; then
            IPA=$(find ios -name '*.ipa' -type f | head -n 1)
            if [[ -n "$IPA" ]]; then
              cp "$IPA" "dist/${APP}-${V}-ios.ipa"
              echo "Copied iOS IPA"
            else
              APPDIR=$(find ios -name 'Runner.app' -type d | head -n 1)
              if [[ -n "$APPDIR" ]]; then
                echo "Creating iOS app zip..."
                zip -r "dist/${APP}-${V}-ios-Runner.app.zip" "$APPDIR"
                echo "Created iOS Runner.app zip"
              fi
            fi
          fi

          # Generate master checksums file
          cd dist
          sha256sum * > SHA256SUMS 2>/dev/null || true
          cd ..

          echo ""
          echo "ðŸ“Š Final release files:"
          ls -lh dist/
          echo ""
          echo "Total files: $(ls -1 dist/ | wc -l)"
          echo "Total size: $(du -sh dist/ | cut -f1)"

      - name: Generate release notes
        id: notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ${{ env.APP_NAME }} ${{ needs.prepare.outputs.version }}


          Cross-platform offline-first personal finance & crypto tracking application.

          **Android:**
          - `*-android.apk` - Install directly on device
          - `*-android.aab` - For Play Store deployment

          **iOS:**
          - `*-ios.ipa` - Signed IPA (if available)
          - `*-ios-Runner.app.zip` - Unsigned app bundle

          **Desktop:**
          - `*-windows-x64.zip` - Windows 10/11
          - `*-macos-x64.zip` - macOS (Intel)
          - `*-linux-x64.zip` - Linux (x64)

          **Web:**
          - `*-web.zip` - Static web bundle

          ### Security

          All artifacts include SHA256 checksums. Verify downloads using the `SHA256SUMS` file:
          ```bash
          sha256sum -c SHA256SUMS
          ```

          ### Build Information
          - Built from: `${{ github.ref }}`
          - Commit: `${{ github.sha }}`
          - Build date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - Flutter channel: ${{ env.FLUTTER_CHANNEL }}
          EOF

          echo "Release notes generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.version }}
          name: "${{ env.APP_NAME }} ${{ needs.prepare.outputs.version }}"
          body_path: release_notes.md
          files: release-artifacts/dist/*
          fail_on_unmatched_files: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "### Release Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "-  Android (APK + AAB)" >> $GITHUB_STEP_SUMMARY
          echo "-  iOS" >> $GITHUB_STEP_SUMMARY
          echo "-  Web" >> $GITHUB_STEP_SUMMARY
          echo "-  Windows" >> $GITHUB_STEP_SUMMARY
          echo "-  macOS" >> $GITHUB_STEP_SUMMARY
          echo "-  Linux" >> $GITHUB_STEP_SUMMARY
